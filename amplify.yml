version: 1
applications:
  - appRoot: .
    frontend:
      phases:
        preBuild:
          commands:
            - echo "Installing Docker Compose"
            - sudo curl -L "https://github.com/docker/compose/releases/download/v2.20.2/docker-compose-linux-x86_64" -o /usr/local/bin/docker-compose
            - sudo chmod +x /usr/local/bin/docker-compose
            - docker --version
            - docker-compose --version
        build:
          commands:
            - echo "Building with Docker Compose"
            - docker-compose -f docker-compose.prod.yml build
            - echo "Starting services"
            - docker-compose -f docker-compose.prod.yml up -d
            - echo "Extracting frontend build"
            - docker cp $(docker-compose -f docker-compose.prod.yml ps -q frontend):/usr/share/nginx/html ./dist
        postBuild:
          commands:
            - echo "Cleaning up containers"
            - docker-compose -f docker-compose.prod.yml down
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'
      cache:
        paths:
          - node_modules/**/*